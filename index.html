<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Acarea√ß√µes J&T (Modelo Oficial)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca PDF (jspdf) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800 p-4 md:p-6">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-lg font-semibold text-slate-700" id="loading-text">Processando...</p>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- Cabe√ßalho -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-lg shadow-sm border border-slate-200 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-red-600">Gerador de Acarea√ß√µes</h1>
                <p class="text-sm text-slate-500">Layout baseado no formul√°rio oficial J&T</p>
            </div>
            <!-- Logo Visualiza√ß√£o no HTML -->
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgwmIpBa-x2_oBe8lYpKz9KbRFr_O1lf4KX0G46S67hqzuZExEwrajG7BYfPu_Baz9tVP_uK6i7OsbshbZdA4-WaEcRaFr1v5D44wM3gYouQBHnEAcB8wtMV2l5JQ7NBq4uDux-1rbMYpY/s320/5c42d91c480329c763370f48fc59489c.png" class="h-12 object-contain" alt="J&T Logo">
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Entrada de Dados -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                    <label class="block text-sm font-bold text-slate-700 mb-2">1. Cole os dados do Excel</label>
                    <div class="text-[10px] text-slate-500 mb-2 p-2 bg-slate-50 rounded border border-slate-100 leading-tight">
                        <strong>Colunas esperadas (ordem do Tab):</strong><br>
                        ID | NF | Nome | Tel | Site | Endere√ßo | Produto | Base | Mot | Data | Atend
                    </div>
                    <textarea id="bulk-input" rows="15" class="w-full p-3 text-xs font-mono border border-slate-300 rounded focus:ring-2 focus:ring-red-500 outline-none resize-none" placeholder="Cole aqui as linhas copiadas do Excel..."></textarea>
                    
                    <div class="flex gap-2 mt-4">
                        <button onclick="processData()" class="flex-1 bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700 transition shadow-sm">Processar Dados</button>
                        <button onclick="document.getElementById('bulk-input').value=''" class="px-4 py-2 border border-slate-300 rounded hover:bg-slate-50 text-slate-600 transition">Limpar</button>
                    </div>
                </div>
            </div>

            <!-- Lista de Confer√™ncia -->
            <div class="lg:col-span-2">
                <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 h-full flex flex-col min-h-[500px]">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b border-slate-100 gap-3">
                        <h2 class="font-bold text-lg text-slate-800">2. Confer√™ncia (<span id="count">0</span>)</h2>
                        <button onclick="uploadToPanel()" id="btn-upload" class="w-full sm:w-auto bg-emerald-600 text-white px-6 py-2 rounded font-bold shadow-sm hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Enviar para o Painel
                        </button>
                    </div>

                    <div id="list-container" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar" style="max-height: 600px;">
                        <div class="text-center text-slate-400 py-20 flex flex-col items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>Aguardando dados...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL do banco de dados (npoint)
        const DATABASE_URL = "https://api.npoint.io/ef789e8a4e2cd9900cf7"; 

        // URL da Logo (Tentativa principal)
        const LOGO_URL = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgwmIpBa-x2_oBe8lYpKz9KbRFr_O1lf4KX0G46S67hqzuZExEwrajG7BYfPu_Baz9tVP_uK6i7OsbshbZdA4-WaEcRaFr1v5D44wM3gYouQBHnEAcB8wtMV2l5JQ7NBq4uDux-1rbMYpY/s320/5c42d91c480329c763370f48fc59489c.png";
        
        // Base64 de backup (Logo J&T Express simples em vermelho) - Garantia de funcionamento
        const LOGO_BASE64_BACKUP = "data:image/png;base64,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";

        // Fun√ß√£o de carregamento aprimorada (Image Object + Canvas + Base64 Backup)
        async function loadLogo() {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Tenta carregar sem bloquear por CORS
                
                img.onload = () => {
                    // Cria um canvas para desenhar a imagem e extrair os dados
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    try {
                        resolve(canvas.toDataURL('image/png'));
                    } catch (e) {
                        console.warn("Bloqueio de CORS no Canvas. Usando backup.", e);
                        resolve(LOGO_BASE64_BACKUP);
                    }
                };

                img.onerror = () => {
                    console.warn("Erro ao carregar imagem externa. Usando backup.");
                    resolve(LOGO_BASE64_BACKUP);
                };

                // Tenta carregar a URL externa
                img.src = LOGO_URL;
            });
        }

        let Base64Logo = null;
        let ProcessedItems = [];

        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function ensureLogoLoaded() {
            if (Base64Logo !== null) return;
            Base64Logo = await loadLogo();
        }
        
        ensureLogoLoaded();

        // --- 1. PROCESSAMENTO DE DADOS ---
        function processData() {
            const raw = document.getElementById('bulk-input').value;
            if (!raw.trim()) {
                alert("Cole os dados primeiro.");
                return;
            }

            const lines = raw.trim().split('\n');
            ProcessedItems = [];

            lines.forEach((line) => {
                if (!line.trim() || line.includes("ID Pedido") || line.includes("Nota Fiscal")) return;
                const cols = line.split('\t').map(c => c.trim());
                if (cols.length < 5) return;

                let rawAddress = cols[5] || "";
                rawAddress = rawAddress.replace(/^Endere√ßo de destinat√°rio:\s*/i, "").replace(/^Endere√ßo:\s*/i, "");

                const item = {
                    id: cols[0],
                    nf: cols[1],
                    nome: cols[2],
                    tel: cols[3],
                    site: cols[4] || "Outros",
                    endereco: rawAddress,
                    produto: cols[6],
                    base: cols[7],
                    motorista: cols[8] || "N√£o Informado",
                    dataHora: cols[9],
                    atendente: cols[10] || "Atendente",
                    uuid: generateUUID()
                };

                const safeBase = (item.base || "").replace(/[^a-zA-Z0-9-]/g, ""); 
                const safeMot = (item.motorista || "").replace(/[^a-zA-Z0-9 -]/g, "").toUpperCase(); 
                item.fileName = `${safeBase} - Acarea√ß√£o Motorista - ${safeBase} - ${safeMot} - ${item.id}.pdf`;

                ProcessedItems.push(item);
            });
            renderList();
        }

        function renderList() {
            const container = document.getElementById('list-container');
            const countSpan = document.getElementById('count');
            const btnUpload = document.getElementById('btn-upload');

            container.innerHTML = '';
            countSpan.innerText = ProcessedItems.length;
            btnUpload.disabled = ProcessedItems.length === 0;

            if (ProcessedItems.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-10">Nenhum dado v√°lido encontrado.</div>';
                return;
            }

            ProcessedItems.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded border border-slate-200 hover:shadow-md transition-shadow duration-200 animate-fade-in";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="overflow-hidden">
                            <span class="font-bold text-slate-800 text-sm block truncate" title="${item.motorista}">${i+1}. ${item.motorista}</span>
                            <span class="text-xs text-slate-500 block truncate" title="${item.fileName}">${item.fileName}</span>
                        </div>
                        <span class="px-2 py-1 bg-red-50 text-red-700 text-xs font-bold rounded border border-red-100 whitespace-nowrap ml-2">${item.site.substring(0, 10)}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-xs text-slate-600 mb-3 bg-slate-50 p-2 rounded">
                        <p class="truncate" title="${item.id}"><strong>Pedido:</strong> ${item.id}</p>
                        <p class="truncate" title="${item.nf}"><strong>NF:</strong> ${item.nf}</p>
                        <p class="col-span-2 truncate" title="${item.nome}"><strong>Cliente:</strong> ${item.nome}</p>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="copyMsgDriver('${item.uuid}')" class="py-1.5 px-2 bg-white border border-slate-300 rounded text-[10px] font-medium text-slate-700 hover:bg-slate-50 hover:text-red-600 transition">Msg Motorista</button>
                        <button onclick="copyOrderData('${item.uuid}')" class="py-1.5 px-2 bg-white border border-slate-300 rounded text-[10px] font-medium text-slate-700 hover:bg-slate-50 hover:text-blue-600 transition">Dados Pedido</button>
                        <button onclick="copyMsgClient('${item.uuid}')" class="py-1.5 px-2 bg-white border border-slate-300 rounded text-[10px] font-medium text-slate-700 hover:bg-slate-50 hover:text-red-600 transition">Msg Cliente</button>
                        <button onclick="previewPDF('${item.uuid}')" class="py-1.5 px-2 bg-slate-800 text-white rounded text-[10px] font-medium hover:bg-slate-900 transition">Ver PDF</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- 2. GERADOR DE PDF ---
        async function createPDFBlob(item) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            await ensureLogoLoaded();

            const siteUpper = (item.site || "").toUpperCase();

            // L√≥gica de sele√ß√£o de Layout
            if (siteUpper.includes("MERCADO")) {
                generateMercadoLivreLayout(doc, item);
            } else if (siteUpper.includes("VIA") || siteUpper.includes("CASAS BAHIA") || siteUpper.includes("VAREJO")) {
                generateViaLayout(doc, item);
            } else {
                generateStandardLayout(doc, item);
            }
            return doc.output('blob');
        }

        // --- LAYOUT PADR√ÉO (J&T) ---
        function generateStandardLayout(doc, item) {
            const pageWidth = doc.internal.pageSize.getWidth(); 
            const pageHeight = doc.internal.pageSize.getHeight(); 
            const margin = 15;
            const contentWidth = pageWidth - (2 * margin);
            let cursorY = 10; 

            doc.setFont("times", "normal");

            // LOGO (Imagem Base64 carregada)
            if (Base64Logo) {
                const logoW = 67.2; 
                const logoH = 18.0; 
                doc.addImage(Base64Logo, 'PNG', (pageWidth - logoW) / 2, cursorY, logoW, logoH);
                cursorY += logoH + 5;
            } else {
                // Fallback extremo
                doc.setFontSize(22);
                doc.setFont("times", "bold");
                doc.setTextColor(220, 0, 0);
                doc.text("J&T EXPRESS", pageWidth / 2, cursorY + 10, { align: "center" });
                doc.setTextColor(0);
                cursorY += 20;
            }

            // T√çTULO
            doc.setFont("times", "normal");
            doc.setFontSize(22);
            doc.text("Declara√ß√£o de Acarea√ß√£o", pageWidth / 2, cursorY, { align: "center" });
            
            const titleW = doc.getTextWidth("Declara√ß√£o de Acarea√ß√£o");
            doc.setLineWidth(0.5);
            doc.line((pageWidth/2)-(titleW/2), cursorY+1, (pageWidth/2)+(titleW/2), cursorY+1);
            doc.setLineWidth(0.1);
            cursorY += 10; 

            doc.setFontSize(12);
            
            // CAIXA 1: DADOS DO CONSUMIDOR
            const box1H = 75; 
            doc.rect(margin, cursorY, contentWidth, box1H);
            let internalY = cursorY + 8;
            
            doc.setFont("times", "bold");
            doc.text("Dados do consumidor", pageWidth / 2, internalY, { align: "center" });
            
            internalY += 10;
            doc.setFont("times", "normal");
            const leftX = margin + 2;
            const lineSpacing = 8.5; 

            doc.text(`Nome do titular da compra: ${item.nome}`, leftX, internalY);
            internalY += lineSpacing;
            
            const siteStr = `Site no qual a compra foi realizada: ${item.site}`;
            doc.text(siteStr, leftX, internalY);
            internalY += lineSpacing; 

            doc.text(`ID Pedido: ${item.id}`, leftX, internalY);
            internalY += lineSpacing;

            const prodLabel = "Nome do produto: ";
            const prodVal = item.produto;
            doc.text(`${prodLabel}${prodVal}`, leftX, internalY);
            internalY += lineSpacing;

            doc.text("As informa√ß√µes acima podem ser confirmadas pelo telefone do titular da compra:", leftX, internalY);
            internalY += lineSpacing;
            doc.text(`${item.tel}`, leftX, internalY);

            cursorY += box1H; 

            // CAIXA UNIFICADA: MOTIVO + QUEM RECEBEU
            const boxMiddleH = 100;
            doc.rect(margin, cursorY, contentWidth, boxMiddleH);
            
            internalY = cursorY + 8;

            // -- Se√ß√£o Motivo --
            doc.setFont("times", "bold");
            doc.text("Motivo da Acarea√ß√£o", pageWidth / 2, internalY, { align: "center" });
            internalY += 8;
            doc.setFont("times", "normal");

            doc.rect(leftX, internalY - 4, 4, 4); 
            doc.text("Destinat√°rio (a) est√° contestando o recebimento da remessa", leftX + 6, internalY);
            internalY += 8;

            doc.rect(leftX, internalY - 4, 4, 4);
            const txtM2 = "Destinat√°rio (a) est√° contestando o recebimento dos volumes devidamente lacrados e sem sinais de viola√ß√£o.";
            const splitM2 = doc.splitTextToSize(txtM2, contentWidth - 12);
            doc.text(splitM2, leftX + 6, internalY);
            
            internalY += 15; 

            // -- Se√ß√£o Quem Recebeu --
            doc.text("Quem recebeu a visita do motorista?", leftX, internalY);
            
            const optX1 = leftX + 75; 
            const optX2 = optX1 + 45;
            
            // Linha 1 checkboxes
            doc.rect(optX1, internalY - 4, 4, 4);
            doc.text("O destinat√°rio", optX1 + 6, internalY);
            doc.rect(optX2, internalY - 4, 4, 4);
            doc.text("Parente / Funcion√°rio", optX2 + 6, internalY);
            
            // Linha 2 checkboxes (Outros)
            internalY += 10;
            doc.rect(optX1, internalY - 4, 4, 4);
            doc.text("Outros ________________________", optX1 + 6, internalY);
            
            internalY += 12;

            doc.setFont("times", "bold");
            doc.text("Nome: _________________________  Documento: ___________________", leftX, internalY);
            doc.setFont("times", "normal");
            internalY += 12;

            doc.text("O recebedor foi reconhecido no ato da acarea√ß√£o?", leftX, internalY);
            internalY += 10;

            doc.rect(leftX, internalY - 4, 4, 4);
            doc.text("Sim, endere√ßo correto", leftX + 6, internalY); 

            const recX2 = leftX + 60;
            doc.rect(recX2, internalY - 4, 4, 4);
            doc.text("Sim, endere√ßo errado", recX2 + 6, internalY);
            
            const recX3 = recX2 + 60;
            doc.rect(recX3, internalY - 4, 4, 4);
            doc.text("N√£o", recX3 + 6, internalY);

            cursorY += boxMiddleH;

            // CAIXA 3: RODAP√â DIVIDIDO
            const box4H = 35; 
            doc.rect(margin, cursorY, contentWidth, box4H);
            
            doc.line(pageWidth / 2, cursorY, pageWidth / 2, cursorY + box4H);

            const centerLeft = margin + (contentWidth / 4);
            doc.text("Cidade", centerLeft, cursorY + 12, { align: "center" });
            doc.setFont("times", "bold");
            doc.text("Assinatura:", margin + 2, cursorY + box4H - 5);
            doc.setFont("times", "normal");

            const centerRight = (pageWidth / 2) + (contentWidth / 4);
            doc.text("______, de ____________ de ______", centerRight, cursorY + 12, { align: "center" });
            doc.setFontSize(10); 
            doc.text("Dia          M√™s e Ano", centerRight, cursorY + 22, { align: "center" });
            doc.setFontSize(12);

            cursorY += box4H;

            // CAIXA 4: ENDERE√áO
            doc.setFont("times", "normal"); 
            doc.setFontSize(12); 
            const footerLineSpacing = 8.5;

            const addrLabel = "Endere√ßo de destinat√°rio: ";
            const addrVal = item.endereco;
            const fullAddr = `${addrLabel}${addrVal}`;
            const splitAddr = doc.splitTextToSize(fullAddr, contentWidth - 4);
            
            const box5H = (splitAddr.length * footerLineSpacing) + 5; 
            
            doc.rect(margin, cursorY, contentWidth, box5H);
            doc.text(splitAddr, leftX, cursorY + 7);
            
            cursorY += box5H;

            // CAIXA 5: MOTORISTA
            const box6H = 15;
            doc.rect(margin, cursorY, contentWidth, box6H);
            
            doc.setFont("times", "normal"); 
            doc.setFontSize(12); 
            doc.text(`MOTORISTA: ${item.motorista} - BASE: ${item.base}`, leftX, cursorY + 10);
        }

        // --- LAYOUT MERCADO LIVRE ---
        function generateMercadoLivreLayout(doc, item) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let cursorY = 15;

            doc.setFont("times", "normal");

            if (Base64Logo) {
                const logoW = 67.2; 
                const logoH = 18.0; 
                doc.addImage(Base64Logo, 'PNG', (pageWidth - logoW) / 2, cursorY, logoW, logoH);
                cursorY += logoH + 15;
            } else {
                cursorY += 30;
            }

            doc.setFont("times", "bold");
            doc.setFontSize(22); 
            doc.text("Modelo de Acarea√ß√£o F√≠sica (confirma√ß√£o de recebimento):", margin, cursorY);
            cursorY += 20;

            doc.setFontSize(12); 
            doc.setFont("times", "normal");
            const text = `Eu, ${item.nome.toUpperCase()}, portador(a) do CPF [____________________], declaro para os devidos fins que recebi o pedido de n√∫mero [${item.nf || item.id}], referente ao produto [${item.produto}], no dia [${item.dataHora || "____/____/______"}].`;
            const splitText = doc.splitTextToSize(text, pageWidth - (2 * margin));
            doc.text(splitText, margin, cursorY);
            cursorY += (splitText.length * 7) + 20;

            const cidade = item.base ? item.base.split('-')[0].trim() : "________________";
            doc.text(`[${cidade}], [____] de [_________] de [______].`, pageWidth / 2, cursorY, { align: "center" });
            cursorY += 30;
            
            doc.line((pageWidth/2)-50, cursorY, (pageWidth/2)+50, cursorY);
            cursorY += 5;
            doc.text("Assinatura do cliente", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 40;

            doc.setFontSize(14); 
            doc.setFont("times", "bold");
            doc.setTextColor(220, 0, 0);
            doc.text("TIRAR FOTO DE QUALQUER DOCUMENTO DO CLIENTE", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 8;
            doc.text("JUNTO A ACAREA√á√ÉO ESCRITA A PR√ìPRIO PUNHO", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 20;

            doc.setTextColor(0);
            doc.setFontSize(12);
            doc.setFont("times", "italic");
            doc.text("Observa√ß√£o: O pacote deve ser entregue somente mediante apresenta√ß√£o do documento de identidade (RG).", margin, cursorY);

            const pageHeight = doc.internal.pageSize.getHeight();
            doc.setFont("times", "normal");
            doc.setFontSize(12);
            doc.text(`MOTORISTA: ${item.motorista} - BASE: ${item.base}`, margin, pageHeight - 15);
        }

        // --- LAYOUT VIA VAREJO ---
        function generateViaLayout(doc, item) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let cursorY = 20;

            doc.setFont("times", "normal");
            doc.setFontSize(12);

            // LOGO
            if (Base64Logo) {
                const logoW = 67.2; 
                const logoH = 18.0; 
                doc.addImage(Base64Logo, 'PNG', (pageWidth - logoW) / 2, cursorY, logoW, logoH);
                cursorY += logoH + 15;
            } else {
                cursorY += 30;
            }

            doc.text(`Data da entrega: ____/____/____`, margin, cursorY);
            cursorY += 8;
            doc.text(`Destinat√°rio: ${item.nome}`, margin, cursorY);
            cursorY += 8;
            doc.text(`Nota: ${item.nf || ""}`, margin, cursorY);
            doc.text(`Pedido: ${item.id}`, margin + 100, cursorY); 
            cursorY += 8;
            doc.text(`Data da Solicita√ß√£o: ____/____/____`, margin, cursorY);
            
            cursorY += 15;

            doc.setFont("times", "bold");
            doc.setFontSize(14);
            doc.text("Formul√°rio de Acarea√ß√£o.", pageWidth / 2, cursorY, { align: "center" });
            
            cursorY += 25;
            doc.setFont("times", "normal");
            doc.setFontSize(12);

            doc.text("Eu, ____________________________________________________________________, grau de parentesco", margin, cursorY);
            cursorY += 10;
            doc.text("__________________ portador do RG ______________________________________ declaro que:", margin, cursorY);
            cursorY += 15;

            doc.text("(   ) Recebi a mercadoria no endere√ßo correto.", margin, cursorY);
            cursorY += 8;
            doc.text("(   ) N√£o recebi a mercadoria.", margin, cursorY);
            cursorY += 8;
            doc.text("(   ) Recebi a mercadoria no endere√ßo devido, porem com avaria.", margin, cursorY);
            cursorY += 15;

            const obsText = "OBS:_________________________________________________________________________________________________________________________________________________________________________________.";
            const splitObs = doc.splitTextToSize(obsText, pageWidth - (2*margin));
            doc.text(splitObs, margin, cursorY);
            cursorY += (splitObs.length * 6) + 20;

            doc.text("___________________________________", margin, cursorY);
            cursorY += 5;
            doc.text("Assinatura do cliente", margin, cursorY);
            cursorY += 10;
            doc.text("RG: ________________________________", margin, cursorY);
            cursorY += 10;
            doc.text("DATA: ____/____/___________.", margin, cursorY);
            
            cursorY += 20;

            doc.text(`Motorista: ${item.motorista}`, margin, cursorY);
            cursorY += 10;
            doc.text("Assinatura: _________________                              Data: ____/____/_______  RG:_______________.", margin, cursorY);
        }

        async function uploadToPanel() {
            if (!confirm("Confirma o envio para o painel?")) return;
            const overlay = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            overlay.style.display = 'flex';
            try {
                txt.innerText = "Baixando dados...";
                const res = await fetch(`${DATABASE_URL}?_=${Date.now()}`);
                let currentData = await res.json();
                if (!currentData || typeof currentData !== 'object') currentData = { files: [] };
                if (!currentData.files) currentData.files = [];

                txt.innerText = "Gerando PDFs...";
                const now = Date.now();
                const dateStr = new Date().toISOString().split('T')[0];
                const deadline = now + (24 * 60 * 60 * 1000);

                for (const item of ProcessedItems) {
                    const blob = await createPDFBlob(item);
                    const reader = new FileReader();
                    const b64 = await new Promise(resolve => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });
                    currentData.files.push({
                        id: generateUUID(),
                        fileName: item.fileName,
                        folderName: dateStr,
                        uploadDate: now,
                        deadline: deadline,
                        status: 'pending',
                        fileURL: b64,
                        whatsappNotified: 'no',
                        valorPedido: 0,
                        valorMulta: 0
                    });
                }
                txt.innerText = "Enviando...";
                await fetch(DATABASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentData)
                });
                alert("Enviado com sucesso!");
                ProcessedItems = [];
                document.getElementById('bulk-input').value = '';
                renderList();
            } catch (err) {
                console.error(err);
                alert("Erro: " + err.message);
            } finally {
                overlay.style.display = 'none';
            }
        }

        function toTitleCase(str) {
            return str.replace(
                /\w\S*/g,
                function(txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }

        function extractDriverName(fullDriverString) {
            let namePart = fullDriverString;
            if (fullDriverString.includes("-")) {
                const parts = fullDriverString.split("-");
                if (parts.length > 1) {
                    namePart = parts[1].trim(); 
                }
            }
            
            const titleCased = toTitleCase(namePart);
            const nameArr = titleCased.split(" ").filter(n => n.length > 0);

            if (nameArr.length > 1) {
                return `${nameArr[0]} ${nameArr[nameArr.length - 1]}`;
            } else if (nameArr.length === 1) {
                return nameArr[0];
            }
            return "Motorista";
        }

        function copyMsgDriver(uuid) {
            const it = ProcessedItems.find(i => i.uuid === uuid);
            if (!it) return;
            
            const driverNameFormatted = extractDriverName(it.motorista);

            const msg = `Ol√° ${driverNameFormatted}, boa noite!

Aqui √© a Micheelly, respons√°vel pelas *acarea√ß√µes e agiliza√ß√µes* da *Next Move ‚Äì J&T Express*.

Pe√ßo, por gentileza, que d√™ *prioridade m√°xima* √†s acarea√ß√µes enviadas em *PDF*.üìå Os clientes alegam n√£o ter recebido os pedidos.

üìù *Orienta√ß√µes r√°pidas:*
1Ô∏è‚É£ Retorne ao local da entrega para verificar a situa√ß√£o.
2Ô∏è‚É£ Caso localize o pedido, realize a entrega e colete a assinatura na declara√ß√£o.
3Ô∏è‚É£ Se necess√°rio, acione o l√≠der da base para confirma√ß√£o digital.

‚ö†Ô∏è *Observa√ß√µes importantes:*
‚úçÔ∏è *Mercado Livre*: exige declara√ß√£o escrita √† m√£o (*pr√≥prio punho*) pelo cliente.
üìÑ *TikTok*: aceita somente acarea√ß√µes via formul√°rio f√≠sico.
üî∏ *N√£o ser√£o aceitas declara√ß√µes sem assinatura, assinaturas incorretas, √°udios ou v√≠deos.* ‚è∞ *Prazo para retorno: 24h ap√≥s o envio do formul√°rio*.

üö´ *A aus√™ncia de retorno poder√° caracterizar extravio vinculado ao motorista.*

üôè Agrade√ßo desde j√° pela colabora√ß√£o e agilidade!`;
            
            copyToClipboard(msg);
        }

        function copyOrderData(uuid) {
            const it = ProcessedItems.find(i => i.uuid === uuid);
            if (!it) return;

            const msg = `Dados do Pedido:

*Motorista: ${it.motorista}*
*Pedido: ${it.id} NF N¬∫. ${it.nf} - ${it.site}*
Esta√ß√£o de coleta: ${it.base}
Nome do destinat√°rio: ${it.nome}
Endere√ßo de destinat√°rio: ${it.endereco}
TEL de destinat√°rio: ${it.tel} 
${it.produto}

*Reclama√ß√£o: Cliente alega que n√£o recebeu seu pedido e n√£o conhece o recebedor*`;

            copyToClipboard(msg);
        }

        function copyMsgClient(uuid) {
            const it = ProcessedItems.find(i => i.uuid === uuid);
            if (!it) return;
            const site = (it.site || "").toLowerCase();
            let msg = "";
            const h = new Date().getHours();
            
            let gr = "bom dia";
            let endGr = "Tenha um √≥timo dia!";
            if (h >= 12 && h < 18) {
                gr = "boa tarde";
                endGr = "Tenha uma √≥tima tarde!";
            } else if (h >= 18) {
                gr = "boa noite";
                endGr = "Tenha uma √≥tima noite!";
            }

            const clientNameFull = toTitleCase(it.nome);

            if (site.includes("mercado")) {
                msg = `Ol√° ${clientNameFull}, ${gr}!\n\nMe chamo ${it.atendente} e sou da Transportadora *J&T Express*, parceira da entrega do *${it.site}*.\n\nVerificamos que voc√™ abriu uma reclama√ß√£o referente o produto *${it.produto}*, no ID do pacote *${it.nf}* da entrega dia *${it.dataHora}*.\n\nPara que possamos auxiliar, escolha uma op√ß√£o:\n\n*1Ô∏è‚É£Recebi o produto*\n*2Ô∏è‚É£N√£o recebi o produto;*\n*3Ô∏è‚É£Recebi o pacote com produtos faltantes;*\n*4Ô∏è‚É£Recebi produto com defeito;*\n*5Ô∏è‚É£Recebi um produto diferente do comprado.*\n\nEstou √† disposi√ß√£o para te ajudar a resolver a situa√ß√£o da melhor forma poss√≠vel.\n\nAguardamos seu retorno e, desde j√°, agradecemos pela aten√ß√£o!\n\n${it.tel}`;
            } else if (site.includes("tiktok")) {
                msg = `Ol√°, ${clientNameFull}, ${gr}!\n\nTudo bem?\n\nSou ${it.atendente}, da *J&T Express*, transportadora respons√°vel pela entrega do seu pedido.\n\nRecebemos uma notifica√ß√£o informando que este pedido *n√£o foi recebido*:\n\n*Origem do pedido:* *${it.site}*\n*C√≥digo de rastreio:* *${it.id}*\n\nPara prosseguirmos com a tratativa, por favor, responda com uma das op√ß√µes abaixo:\n\n1Ô∏è‚É£ *Recebi o produto*\n2Ô∏è‚É£ *N√£o recebi o produto*\n3Ô∏è‚É£ *Recebi o pacote com produtos faltantes*\n4Ô∏è‚É£ *Recebi o produto com defeito*\n5Ô∏è‚É£ *Recebi um produto diferente do comprado*\n6Ô∏è‚É£ *N√£o abri reclama√ß√£o; recebi o pacote intacto*\n7Ô∏è‚É£ *Recebi o produto danificado* Agradecemos a coopera√ß√£o e pedimos desculpas por qualquer transtorno causado. \n\n${endGr} \n${it.tel} - ${it.base}`;
            } else if (site.includes("via")) {
                msg = `Ol√° ${clientNameFull}, ${gr}!\n\nMe chamo ${it.atendente} e sou da Transportadora *J&T Express*, respons√°vel pela sua entrega.\n\n*NF:* ${it.nf}\n*PEDIDO:* ${it.nf}\n*Rastreio:* ${it.id}\n*Conte√∫do do pacote:* ${it.produto}\n*Loja:* ${it.site}\n\nGostaria de confirmar se recebeu todos os volumes no ato da entrega, voc√™\nconfirmou o recebimento no site da compra ?\n\n${it.tel}`;
            } else {
                msg = `Ol√° ${clientNameFull}, ${gr}!\n\nMeu nome √© ${it.atendente}, sou representante da Transportadora *J&T Express*, parceira de entregas da *${it.site}*!\n\nVerificamos que voc√™ abriu uma reclama√ß√£o referente ao pedido *${it.id}- (${it.nf})*.\n\nConte√∫do do pacote: ${it.produto}\n\nPara que possamos auxiliar, escolha uma op√ß√£o:\n\n1Ô∏è‚É£ *Recebi o produto*\n2Ô∏è‚É£ *N√£o recebi o produto*\n3Ô∏è‚É£ *Recebi o pacote com produtos faltantes*\n4Ô∏è‚É£ *Recebi o produto com defeito*\n5Ô∏è‚É£ *Recebi um produto diferente do comprado*\n6Ô∏è‚É£ *Recebi o produto danificado*\n7Ô∏è‚É£ *N√£o abri reclama√ß√£o, recebi meu pacote correto* Agradecemos a coopera√ß√£o e pedimos desculpas por qualquer transtorno causado. \n\n${endGr} \n${it.tel} - ${it.base}`;
            }
            copyToClipboard(msg);
        }

        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Mensagem copiada!");
        }

        async function previewPDF(uuid) {
            const i = ProcessedItems.find(x => x.uuid === uuid);
            if (!i) return;
            const b = await createPDFBlob(i);
            window.open(URL.createObjectURL(b));
        }
    </script>
</body>
</html>
