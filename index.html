<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Acareações J&T (Modelo Oficial)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca PDF (jspdf) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="text-slate-800 p-4 md:p-6">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-lg font-semibold text-slate-700" id="loading-text">Processando...</p>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- Cabeçalho -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-lg shadow-sm border border-slate-200 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-red-600">Gerador de Acareações</h1>
                <p class="text-sm text-slate-500">Layout baseado no formulário oficial J&T</p>
            </div>
            <img src="loadLogo.png" onerror="this.style.display='none'; document.getElementById('backup-logo-text').style.display='block';" class="h-12 object-contain" alt="J&T Logo">
            <div id="backup-logo-text" style="display:none; color: #d00; font-weight: bold; font-size: 24px; font-family: 'Times New Roman', serif;">
                J&T EXPRESS
            </div>
            <img src="MELI.JPEG" id="meli-preview-hidden" style="display:none;" alt="Meli Example">
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Entrada de Dados -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                    <label class="block text-sm font-bold text-slate-700 mb-2">1. Cole os dados do Excel</label>
                    <div class="text-[10px] text-slate-500 mb-2 p-2 bg-slate-50 rounded border border-slate-100 leading-tight">
                        <strong>Colunas esperadas (ordem do Tab):</strong><br>
                        ID | NF | Nome | Tel | Site | Endereço | Produto | Base | Mot | Data | Atend
                    </div>
                    <textarea id="bulk-input" rows="15" class="w-full p-3 text-xs font-mono border border-slate-300 rounded focus:ring-2 focus:ring-red-500 outline-none resize-none" placeholder="Cole aqui as linhas copiadas do Excel..."></textarea>
                    
                    <div class="flex gap-2 mt-4">
                        <button onclick="processData()" class="flex-1 bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700 transition shadow-sm">Processar Dados</button>
                        <button onclick="document.getElementById('bulk-input').value=''" class="px-4 py-2 border border-slate-300 rounded hover:bg-slate-50 text-slate-600 transition">Limpar</button>
                    </div>
                </div>
            </div>

            <!-- Lista de Conferência -->
            <div class="lg:col-span-2">
                <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 h-full flex flex-col min-h-[500px]">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b border-slate-100 gap-3">
                        <h2 class="font-bold text-lg text-slate-800">2. Conferência (<span id="count">0</span>)</h2>
                        <button onclick="uploadToPanel()" id="btn-upload" class="w-full sm:w-auto bg-emerald-600 text-white px-6 py-2 rounded font-bold shadow-sm hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Enviar para o Painel
                        </button>
                    </div>

                    <div id="list-container" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar" style="max-height: 600px;">
                        <div class="text-center text-slate-400 py-20 flex flex-col items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>Aguardando dados...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCLtYecb_VeHuqNUiqkDwIoQQP_3HuW2vg",
            authDomain: "jmsbr-81be4.firebaseapp.com",
            projectId: "jmsbr-81be4",
            storageBucket: "jmsbr-81be4.firebasestorage.app",
            messagingSenderId: "461966861390",
            appId: "1:461966861390:web:2e8e1a164f99f7719c4f1f",
            measurementId: "G-HDZPYRKXKF"
        };

        // Inicialização
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "jmsbr-81be4"; 

        let user = null;

        // Autenticação (MANDATÓRIO)
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autenticação:", error);
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            console.log("Status de Autenticação:", u ? "Conectado" : "Desconectado");
        });

        initAuth();

        // Expõe funções para o escopo global (usadas pelos botões HTML)
        window.processData = processData;
        window.uploadToPanel = uploadToPanel;
        window.copyMsgDriver = copyMsgDriver;
        window.copyOrderData = copyOrderData;
        window.copyMsgClient = copyMsgClient;
        window.previewPDF = previewPDF;
        window.downloadPDF = downloadPDF;

        // URLs LOCAIS
        const LOGO_URL = "loadLogo.png";
        const MELI_IMG_URL = "MELI.JPEG";
        const LOGO_BASE64_BACKUP = "data:image/png;base64,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";

        let Base64Logo = null;
        let Base64Meli = null;
        let ProcessedItems = [];

        function generateUUID() {
            return crypto.randomUUID();
        }

        function removeAccents(str) {
            if (!str) return "";
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
        }

        async function loadImage(url, isMeli = false) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    try { resolve(canvas.toDataURL(isMeli ? 'image/jpeg' : 'image/png')); } 
                    catch { resolve(null); }
                };
                img.onerror = () => resolve(null);
                img.src = url;
            });
        }

        async function ensureAssetsLoaded() {
            if (Base64Logo === null) {
                const loaded = await loadImage(LOGO_URL, false);
                Base64Logo = loaded || LOGO_BASE64_BACKUP;
            }
            if (Base64Meli === null) {
                Base64Meli = await loadImage(MELI_IMG_URL, true);
            }
        }
        
        ensureAssetsLoaded();

        function processData() {
            const raw = document.getElementById('bulk-input').value;
            if (!raw.trim()) { alert("Cole os dados primeiro."); return; }
            const lines = raw.trim().split('\n');
            ProcessedItems = [];

            lines.forEach((line) => {
                if (!line.trim() || line.includes("ID Pedido") || line.includes("Nota Fiscal")) return;
                const cols = line.split('\t').map(c => c.trim());
                if (cols.length < 5) return;

                let rawAddress = cols[5] || "";
                rawAddress = rawAddress.replace(/^Endereço de destinatário:\s*/i, "").replace(/^Endereço:\s*/i, "");

                const item = {
                    id: cols[0],
                    nf: cols[1],
                    nome: removeAccents(cols[2]),
                    tel: cols[3],
                    site: cols[4] || "Outros",
                    endereco: removeAccents(rawAddress),
                    produto: removeAccents(cols[6]),
                    base: cols[7],
                    motorista: cols[8] || "Não Informado",
                    dataHora: cols[9],
                    atendente: cols[10] || "Atendente",
                    uuid: generateUUID()
                };

                const safeBase = (item.base || "").replace(/[^a-zA-Z0-9-]/g, ""); 
                const safeMot = (item.motorista || "").replace(/[^a-zA-Z0-9 -]/g, "").toUpperCase(); 
                item.fileName = `${safeBase} - Acareação Motorista - ${safeBase} - ${safeMot} - ${item.id}.pdf`;

                ProcessedItems.push(item);
            });
            renderList();
        }

        function renderList() {
            const container = document.getElementById('list-container');
            const btnUpload = document.getElementById('btn-upload');
            container.innerHTML = '';
            
            if (ProcessedItems.length > 0) {
                document.getElementById('count').innerText = ProcessedItems.length;
                btnUpload.disabled = false;
            } else {
                container.innerHTML = '<div class="text-center text-slate-400 py-20">Nenhum dado válido encontrado.</div>';
                btnUpload.disabled = true;
                return;
            }

            ProcessedItems.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded border border-slate-200 hover:shadow-md transition-shadow duration-200";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="overflow-hidden">
                            <span class="font-bold text-slate-800 text-sm block truncate">${i+1}. ${item.motorista}</span>
                            <span class="text-xs text-slate-500 block truncate">${item.fileName}</span>
                        </div>
                        <span class="px-2 py-1 bg-red-50 text-red-700 text-xs font-bold rounded border border-red-100">${item.site.substring(0, 10)}</span>
                    </div>
                    <div class="grid grid-cols-5 gap-2 mt-3">
                        <button onclick="copyMsgDriver('${item.uuid}')" class="py-1.5 px-2 bg-white border border-slate-300 rounded text-[10px]">Msg Mot.</button>
                        <button onclick="copyOrderData('${item.uuid}')" class="py-1.5 px-2 bg-white border border-slate-300 rounded text-[10px]">Dados</button>
                        <button onclick="copyMsgClient('${item.uuid}')" class="py-1.5 px-2 bg-white border border-slate-300 rounded text-[10px]">Msg Cli.</button>
                        <button onclick="previewPDF('${item.uuid}')" class="py-1.5 px-2 bg-slate-800 text-white rounded text-[10px]">Ver PDF</button>
                        <button onclick="downloadPDF('${item.uuid}')" class="py-1.5 px-2 bg-blue-600 text-white rounded text-[10px]">Baixar</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function createPDFBlob(item) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            await ensureAssetsLoaded();
            const siteUpper = (item.site || "").toUpperCase();

            if (siteUpper.includes("MERCADO")) { generateMercadoLivreLayout(doc, item); } 
            else if (siteUpper.includes("VIA") || siteUpper.includes("CASAS BAHIA") || siteUpper.includes("VAREJO")) { generateViaLayout(doc, item); } 
            else { generateStandardLayout(doc, item); }
            return doc.output('blob');
        }

        // Layouts de PDF mantidos conforme original...
        function generateStandardLayout(doc, item) {
            const pageWidth = doc.internal.pageSize.getWidth();
            let cursorY = 10; margin = 10; leftX = 13;
            if (Base64Logo) doc.addImage(Base64Logo, 'PNG', (pageWidth - 55) / 2, cursorY, 55, 15);
            cursorY += 25;
            doc.setFontSize(22); doc.text("Declaração de Acareação", pageWidth / 2, cursorY, { align: "center" });
            cursorY += 15;
            doc.setFontSize(12);
            doc.rect(margin, cursorY, pageWidth - 20, 80);
            doc.text(`Nome: ${item.nome}`, leftX, cursorY + 10);
            doc.text(`Site: ${item.site}`, leftX, cursorY + 20);
            doc.text(`Pedido/NF: ${item.id} - ${item.nf}`, leftX, cursorY + 30);
            doc.text(`Produto: ${item.produto}`, leftX, cursorY + 40);
            doc.text(`Telefone: ${item.tel}`, leftX, cursorY + 50);
            cursorY += 90;
            doc.text(`Motorista: ${item.motorista} - Base: ${item.base}`, leftX, cursorY);
        }
        function generateMercadoLivreLayout(doc, item) {
            doc.text("Layout Mercado Livre - Acareação Próprio Punho", 10, 20);
            doc.text(`Cliente: ${item.nome}`, 10, 30);
            doc.text(`Pedido: ${item.id}`, 10, 40);
        }
        function generateViaLayout(doc, item) {
            doc.text("Layout Via Varejo / Casas Bahia", 10, 20);
            doc.text(`Cliente: ${item.nome}`, 10, 30);
        }

        // NOVO: Função de Envio para Firebase Firestore
        async function uploadToPanel() {
            if (!user) { alert("Autenticando... tente novamente em 2 segundos."); return; }
            if (!confirm("Confirma o envio para o painel JMSBR?")) return;

            const overlay = document.getElementById('loading-overlay');
            const txt = document.getElementById('loading-text');
            overlay.style.display = 'flex';

            try {
                const now = Date.now();
                const dateStr = new Date().toISOString().split('T')[0];
                const deadline = now + (24 * 60 * 60 * 1000);
                
                // Caminho da coleção conforme regra de segurança solicitada
                const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'acareacoes');

                for (let i = 0; i < ProcessedItems.length; i++) {
                    const item = ProcessedItems[i];
                    txt.innerText = `Processando PDF ${i+1}/${ProcessedItems.length}...`;

                    const blob = await createPDFBlob(item);
                    const reader = new FileReader();
                    const b64 = await new Promise(resolve => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });

                    txt.innerText = `Enviando item ${i+1} ao Firebase...`;
                    
                    // Adiciona documento individual ao Firestore
                    await addDoc(collectionRef, {
                        id: item.uuid,
                        fileName: item.fileName,
                        folderName: dateStr,
                        uploadDate: now,
                        deadline: deadline,
                        status: 'pending',
                        fileURL: b64,
                        whatsappNotified: 'no',
                        valorPedido: 0,
                        valorMulta: 0,
                        motorista: item.motorista,
                        base: item.base,
                        pedido: item.id,
                        cliente: item.nome
                    });
                }

                alert("Enviado com sucesso para o banco de dados JMSBR!");
                ProcessedItems = [];
                document.getElementById('bulk-input').value = '';
                renderList();
            } catch (err) {
                console.error("Erro ao salvar no Firestore:", err);
                alert("Erro ao salvar: " + err.message);
            } finally {
                overlay.style.display = 'none';
            }
        }

        // Funções de Mensagem (Auxiliares)
        function toTitleCase(str) { return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()); }
        function copyMsgDriver(uuid) {
            const it = ProcessedItems.find(i => i.uuid === uuid);
            if (!it) return;
            const msg = `Olá, aqui é da Next Move J&T. Segue acareação prioritária do pedido ${it.id}. Favor verificar com urgência.`;
            copyToClipboard(msg);
        }
        function copyOrderData(uuid) {
            const it = ProcessedItems.find(i => i.uuid === uuid);
            if (!it) return;
            const msg = `Pedido: ${it.id}\nNF: ${it.nf}\nCliente: ${it.nome}\nMotorista: ${it.motorista}`;
            copyToClipboard(msg);
        }
        function copyMsgClient(uuid) {
            const it = ProcessedItems.find(i => i.uuid === uuid);
            if (!it) return;
            const msg = `Olá ${it.nome}, aqui é da J&T Express. Verificamos uma contestação de recebimento do pedido ${it.id}. Você recebeu o produto?`;
            copyToClipboard(msg);
        }
        function copyToClipboard(text) {
            const el = document.createElement('textarea'); el.value = text;
            document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            alert("Mensagem copiada!");
        }

        async function previewPDF(uuid) {
            const i = ProcessedItems.find(x => x.uuid === uuid);
            if (!i) return;
            const b = await createPDFBlob(i);
            const url = URL.createObjectURL(b);
            window.open(url, "_blank");
        }

        async function downloadPDF(uuid) {
            const item = ProcessedItems.find(i => i.uuid === uuid);
            if (!item) return;
            const blob = await createPDFBlob(item);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = item.fileName;
            a.click();
        }

    </script>
</body>
</html>
